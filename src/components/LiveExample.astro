---
import type { HTMLAttributes } from 'astro/types';
import { markdown } from '@astropub/md'

type Feature = 'anchor-name' | 'custom-functions' | 'animation-range' | 'timeline-scope' | 'baseline-source' | 'at-scope' | 'cap' | 'style-queries';

interface Props extends HTMLAttributes<'a'> {
	caption?: string;
	shouldHideHTML?: boolean;
	shouldHideCSS?: boolean;
	isScoped?: boolean;
	require?: Feature | Feature[];
}

const {
	shouldHideHTML,
	shouldHideCSS,
	caption,
	isScoped = false,
	require: requireProp,
	...props
} = Astro.props;

// TODO: use a proper sanitizer, lol.
let html = await Astro.slots.render('default');
const foundHTML = html.match(/<pre[^>]*language-html[^>]*>([\s\S]+?)<\/pre>/i)?.[1]?.replaceAll(/<[^>]+>/g, '')?.replaceAll('&lt;', '<')?.replaceAll('&gt;', '>')?.replaceAll('&quot;', '"')?.replaceAll('&#x26;', '&')?.replaceAll('&amp;', '&')?.replaceAll('&#x3C;', '<');

const foundCSS = html.match(/<pre[^>]*language-css[^>]*>([\s\S]+?)<\/pre>/i)?.[1]?.replaceAll(/<[^>]+>/g, '')?.replaceAll('&lt;', '<')?.replaceAll('&gt;', '>')?.replaceAll('&quot;', '"')?.replaceAll('&amp;', '&')?.replaceAll('#x26;', '')?.replaceAll('&#x3C;', '<');

if (shouldHideHTML) {
	html = html.replaceAll(/<pre[^>]*language-html[^>]*>([\s\S]+?)<\/pre>/gi, '');
}

if (shouldHideCSS) {
	html = html.replaceAll(/<pre[^>]*language-css[^>]*>([\s\S]+?)<\/pre>/gi, '');
}

const captionHTML = caption ? (await markdown(caption)).toString().trim().replace(/^<p>(.+)<\/p>$/, '$1') : undefined;

const css = isScoped ? `@scope{${foundCSS}}` : foundCSS;

const require = requireProp
	? [requireProp].flat().map(feature => `require-${feature}`)
	: undefined;

---

<figure {...props} class:list={[props.class, require]}>
	<Fragment set:html={foundHTML} />
	<Fragment set:html={html} />
	{captionHTML ? <figcaption set:html={captionHTML} /> : null}
	<style set:html={css} />
</figure>
